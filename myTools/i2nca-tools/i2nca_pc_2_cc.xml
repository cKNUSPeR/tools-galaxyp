<tool id="i2nca_pc_2_cc" name="i2nca Conversion to continuous centroid" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">

	<description>
        Convert centroid imzML files with i2nca and m2aia to obtain continuous centroid files.

    </description>
	
    <macros>
    <import>macros.xml</import>
    </macros>
    
    <requirements>
    <!-- We'll skip the reqirements for now. Later we get a biocontainer, for now we'll do wonky conda env stuff-->
    </requirements>

    <!-- ? how to implement the optional parameters of m2aia preprocessing (see resp. macro) -->
    <command detect_errors="exit_code"><![CDATA[
    cp "${infile.extra_files_path}/imzml" indata.imzML &&
    cp "${infile.extra_files_path}/ibd" indata.ibd &&

    #if $choose_strategy.strategy == "fixed":

        #if $m2aia.use_m2aia_preproc == "FALSE":
            'i2nca_convert_to_cc' 'indata.imzML' './outdata' '$choose_strategy.strategy' '--acc' '$choose_strategy.value' &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_cont_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE": 
            'i2nca_convert_to_pc' 'indata.imzML' './outdata' '$choose_strategy.strategy' '--acc' '$choose_strategy.value'  @m2aia_parameters@ &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_cont_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #end if
    #end if
    #if $choose_strategy.strategy == "unique":
        #if $m2aia.use_m2aia_preproc == "FALSE":
        ## <!-- TODO: register cwt in the cli-->
            'i2nca_convert_to_pc' 'indata.imzML' './outdata' '$choose_strategy.strategy' &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_cont_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE":

            'i2nca_convert_to_pc' 'indata.imzML' './outdata' '$choose_strategy.strategy' @m2aia_parameters@ &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_cont_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml
        #end if
    #end if
    ]]></command>

    <inputs>
        <param name="infile" type="data" format="imzml" label="MSI data" help="Load the .imzml file on which the QC should be performed"/>

        <conditional name="choose_strategy">
            <param name="strategy" label="Choose how the centroids in the imzML file should be detected:" type="select" help="Different stategies can be used.">
                <option value="fixed" >Use a fixed axis</option>
                <option value="unique" >Use all unique m/z values</option>
            </param>

            <when value="fixed">
                <param name="value" label="Choose the accuracy of the shared axis in ppm:" type="integer"
                value="20"
                help="With this option, a mz axis will be calculated based on the ppm step size provided.
                      To this axis, all pixels will be binned."/>

            </when>

            <when value="unique">

            </when>
        </conditional>


       <expand macro="m2aia_preprocessing"/>

    </inputs>

    <outputs>
        <data format="imzml" name="outfile_imzml" label="ContinuousCentroid imzML, Conversion result of ${on_string}: imzML"/>
    </outputs>

    <help><![CDATA[
        TODO: first try of prof2centr, cwt is not supported and should redirect to preset
    ]]></help>
</tool>
