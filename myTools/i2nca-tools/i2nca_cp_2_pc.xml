<tool id="i2nca_cp_2_pc" name="i2nca Conversion to processed centroid" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">

	<description>
        Convert profile imzML files with i2nca and m2aia to obtain processed centroid files.

    </description>
	
    <macros>
    <import>macros.xml</import>
    </macros>
    
    <requirements>
    <!-- We'll skip the reqirements for now. Later we get a biocontainer, for now we'll do wonky conda env stuff-->
    </requirements>


    <command detect_errors="exit_code"><![CDATA[
    cp "${infile.extra_files_path}/imzml" indata.imzML &&
    cp "${infile.extra_files_path}/ibd" indata.ibd &&

    #if $choose_strategy.strategy == "set_find_peaks":

        #if $m2aia.use_m2aia_preproc == "FALSE":
            'i2nca_convert_to_pc' 'indata.imzML' './outdata' '$choose_strategy.strategy' '--fp_hei' '$choose_strategy.fp_hei' '--fp_thr' '$choose_strategy.fp_thr' '--fp_dis' '$choose_strategy.fp_dis' &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_proc_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_proc_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE": 
            'i2nca_convert_to_pc' 'indata.imzML' './outdata' '$choose_strategy.strategy' '--fp_hei' '$choose_strategy.fp_hei' '--fp_thr' '$choose_strategy.fp_thr' '--fp_dis' '$choose_strategy.fp_dis' @m2aia_parameters@ &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_proc_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_proc_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #end if
    #end if
    #if $choose_strategy.strategy == "set_find_cwt_peaks":
        #if $m2aia.use_m2aia_preproc == "FALSE":
        ## <!-- TODO: register cwt in the cli-->
            'i2nca_convert_to_pc' 'indata.imzML' './outdata' '$choose_strategy.strategy' &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_proc_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_proc_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE":

            'i2nca_convert_to_pc' 'indata.imzML' './outdata' '$choose_strategy.strategy' &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_proc_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_proc_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml
        #end if
    #end if
    ]]></command>

    <inputs>
        <param name="infile" type="data" format="imzml" label="MSI data" help="Load the .imzml file on which the QC should be performed"/>

        <conditional name="choose_strategy">
            <param name="strategy" label="Choose how the centroids in the imzML file should be detected:" type="select" help="Different stategies can be used.">
                <option value="set_find_peaks" >Find peaks with local maxima</option>
                <option value="set_find_cwt_peaks" >Find peaks with continuous wavelet transformation</option>
            </param>

            <when value="set_find_peaks">
                <param name="fp_hei" label="Required heith of peak:" type="float"  value="20" 
                       help="Required heith of peak"/>
                <param name="fp_thr" label="Required threshold of peaks:" type="float"  value="5" 
                    help="The vertical distance to its neighboring samples"/>
                <param name="fp_dis" label="Required minimal horizontal distance:" type="float"  value="3" min="1" 
                    help="Tge horizontal distance in samples between neighbouring peaks"/>
            </when>

            <when value="set_find_cwt_peaks">
                <param name="value" label="CWT, not implemented:" type="integer"
                       value="20"/>

            </when>
        </conditional>


       <expand macro="m2aia_preprocessing"/>

    </inputs>

    <outputs>
        <data format="imzml" name="outfile_imzml" label="ProcessedCentroid imzML, Conversion result of ${on_string}: imzML"/>
    </outputs>

    <help><![CDATA[
        TODO: first try of prof2centr, cwt is not supported and should redirect to preset
    ]]></help>
</tool>
