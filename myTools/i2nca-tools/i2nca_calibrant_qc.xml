<tool id="i2nca_calibrant_qc" name="i2nca Calibrant QC Report" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">

	<description>
        Create a Calibrant Quality control reports for any kind of .imzML file.
        Supply a csv  file with Signals to visualize them and their accuracies
        Different metrics will be visualized as a pdf report.
    </description>
	
    <macros>
    <import>macros.xml</import>
    </macros>
    
    <requirements>
        <container type="docker">biocontainers/i2nca:0.3.12_cv1</container>
    </requirements>


    <command detect_errors="exit_code"><![CDATA[
    cp "${infile.extra_files_path}/imzml" indata.imzML &&
    cp "${infile.extra_files_path}/ibd" indata.ibd &&
    'i2nca_calibrant_qc' 'indata.imzML' './data' '$csv_annotation' --ppm '$ppm' --sample_size '$subsample'
    ]]></command>

    <inputs>
        <param name="infile" type="data" format="imzml" label="MSI data" help="Load the imzML file (as Composite) on which the QC should be performed"/>
        <param name="csv_annotation" label="Input csv file with signal annotation" type="data" format="csv" help="Load an .csv file for theoretical signals on which the QC should be performed.
        Please use ';' as delimiter. The columns with the signals must be named 'name' and the respecive thoeretical m/z value must be named 'mz'" />
        <param name="ppm" value="50" type="integer" label="ppm range (plusminus)" help="Cutoff on accuracy in ppm.
        Determines the interval around the theoretical signal that is still considered in the report."/>
        <param name="subsample" value="0.05" type="float" label="Subsample Percentage" help="Subset percentage of the file that is used in the raw data overview."/>
    </inputs>


    <outputs>
            <data name="CalibrantQC" label="Calibrant QC report on ${on_string}" from_work_dir="data_calibrant_QC.pdf" format="pdf" />
    </outputs>

    <test>
        <expand macro="pp_infile"/>
        <conditional name="choose_strategy">
            <param name="strategy" value="fixed_alignment" />
            <param name="value" value="0.5" />
        </conditional>
        <conditional name="m2aia">
            <param name="use_m2aia_preproc" value="FALSE" />
        </conditional>
        <output name="outfile_imzml" ftype="imzml">
            <extra_files type="file" file="pp_test1.imzml" name="imzml" lines_diff="6"/>
            <extra_files type="file" file="pp_test1.ibd" name="ibd" compare="sim_size"/>
        </output>
    </test>


    <tests>
        <!-- Test 1: QC on pp-->
        <test>
            <expand macro="pp_infile"/>
            <param name="csv_annotation" value="calibrant.csv" ftype="csv"/>
            <param name="ppm" value="50" />
            <param name="subsample" value="1.0">
            <output name="CalibrantQC" file="Calibrant_QC_Report_PP.pdf" compare="sim_size"/>
        </test>

        <!-- Test 2: QC on cc-->
        <test>
            <expand macro="cc_infile"/>
            <param name="csv_annotation" value="calibrant.csv" ftype="csv"/>
            <param name="ppm" value="50" />
            <param name="subsample" value="1.0">
            <output name="CalibrantQC" file="Calibrant_QC_Report_CC.pdf" compare="sim_size"/>
        </test>

        <!-- Test 3: QC on cp-->
        <test>
            <expand macro="cp_infile"/>
            <param name="csv_annotation" value="calibrant.csv" ftype="csv"/>
            <param name="ppm" value="50" />
            <param name="subsample" value="1.0">
            <output name="CalibrantQC" file="Calibrant_QC_Report_CP.pdf" compare="sim_size"/>
        </test>

        <!-- Test 4: QC on pc-->
        <test>
            <expand macro="pc_infile"/>
            <param name="csv_annotation" value="calibrant.csv" ftype="csv"/>
            <param name="ppm" value="50" />
            <param name="subsample" value="1.0">
            <output name="CalibrantQC" file="Calibrant_QC_Report_PC.pdf" compare="sim_size"/>
        </test>

        <!-- Test 45: QC on jpc-->
        <test>
            <expand macro="jpc_infile"/>
            <param name="csv_annotation" value="calibrant.csv" ftype="csv"/>
            <param name="ppm" value="50" />
            <param name="subsample" value="1.0">
            <output name="CalibrantQC" file="Calibrant_QC_Report_jPC.pdf" compare="sim_size"/>
        </test>


    <help><![CDATA[
        @I2NCA_DESCRIPTION@
    
        This tool performs a quality control report generation on any imzml file. 
        In the report, different metrics will be visualized. This report doesn't require any input other that a dataset.
    
        **Input data**
        
    
        @MSIDATA_INPUT_DESCRIPTION@

        Signal annotation: Please provide a list of m/z values of interest as csv file with ";" delimiter:
        - The column with a unique identifier for each mass of interest must be called "name".
        - The m/z value of interest must be provided as "mz".
        - The annotation file may contain any additional columns.

        ppm range: Provide the half-interval around the m/z values of interest where peaks are still considered part of the signal.

        subsample percentage: Set the percentage of pixels that are utilized for visualization. Changing this number helps adjust the readability of some graphs in the report.


        
        ]]></help>
        <citations>
            <citation type="bibtex">
                @misc{githubi2nca,
                author = {Jannik Witte},
                title = {i2nca},
                publisher = {GitHub},
                journal = {Github repository},
                url = {https://github.com/cKNUSPeR/i2nca}
            }
            </citation>
            <citation type="bibtex">
                @article{10.1093/gigascience/giab049,
                    author = {Cordes, Jonas and Enzlein, Thomas and Marsching, Christian and Hinze, Marven and Engelhardt, Sandy and Hopf, Carsten and Wolf, Ivo},
                    title = "{M2aiaâ€”Interactive, fast, and memory-efficient analysis of 2D and 3D multi-modal mass spectrometry imaging data}",
                    journal = {GigaScience},
                    volume = {10},
                    number = {7},
                    year = {2021},
                    month = {07},
                    issn = {2047-217X},
                    doi = {10.1093/gigascience/giab049},
                    url = {https://doi.org/10.1093/gigascience/giab049}
                }
            </citation>
        </citations>
</tool>