<tool id="i2nca_pp_2_cp" name="i2nca Conversion to continuous profile" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">

	<description>
        Convert processed profile imzML files with i2nca and m2aia.

    </description>
	
    <macros>
    <import>macros.xml</import>
    </macros>
    
    <requirements>
    <!-- We'll skip the reqirements for now. Later we get a biocontainer, for now we'll do wonky conda env stuff-->
    </requirements>

    <!-- ? how to implement the optional parameters of m2aia preprocessing (see resp. macro) -->
    <command detect_errors="exit_code"><![CDATA[
    cp "${infile.extra_files_path}/imzml" indata.imzML &&
    cp "${infile.extra_files_path}/ibd" indata.ibd &&
    #if $choose_strategy.strategy == "fixed_alignment":
        #if $m2aia.use_m2aia_preproc == "FALSE":
            'i2nca_convert_to_cp' '--cov' '${choose_strategy.value}' 'indata.imzML' './outdata' '$choose_strategy.strategy' &&

            mkdir $outfile_imzml.files_path &&
            mv ./outdata_conv_output_cont_profile.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_profile.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE":
        <!-- TODO add macro for m2aia-->
            'i2nca_convert_to_cp' '--acc' '${choose_strategy.value}' 'indata.imzML' './outdata' '$choose_strategy.strategy' @M2AIA_PARAMETERS@ &&
            mkdir $outfile_imzml.files_path &&
            mv ./outdata_conv_output_cont_profile.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_profile.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #end if
    #end if
    #if $choose_strategy.strategy == "fixed_binning":
        #if $m2aia.use_m2aia_preproc == "FALSE":
            'i2nca_convert_to_cp' '--acc' '${choose_strategy.value}' 'indata.imzML' './outdata' '$choose_strategy.strategy' &&

            mkdir $outfile_imzml.files_path &&
            mv ./outdata_conv_output_cont_profile.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_profile.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE":
            'i2nca_convert_to_cp' '--acc' '${choose_strategy.value}' 'indata.imzML' './outdata' '$choose_strategy.strategy' @M2AIA_PARAMETERS@ &&
            mkdir $outfile_imzml.files_path &&
            mv ./outdata_conv_output_cont_profile.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_profile.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #end if
    #end if
    ]]></command>
    <!-- #else:
            '/home/ubuntu/anaconda3/envs/i2nca/bin/python' i2nca_convert_to_cp - -cov '$choose_strategy.strategy.Coverage' - -bsl '$use_m2aia_preproc.baseline.bsl' - -bsl_hws '$use_m2aia_preproc.baseline.bsl_hws' './data.imzML' './data' '$choose_strategy.strategy' -->
    <!-- ? ? 2DO w/ Niko: Adiitional documents that are optional -->
    <inputs>
        <param name="infile" type="data" format="imzml" label="MSI data" help="Load the .imzml file on which the QC should be performed"/>

        <conditional name="choose_strategy">
            <param name="strategy" label="Choose how the continous profile imzML file should be created:" type="select" help="Different stategies can be used.">
                <option value="fixed_alignment" >Alignment</option>
                <option value="fixed_binning" >Binning</option>
            </param>
            <when value="fixed_alignment">
                <!-- ? ?can "value" have two different names? here it is the coverage -->
                <param name="value" label="Choose a subsample range for average mz axis calculation:" type="float"
                       value="0.05" min="0.00" max="1.00"
                       help="With this option, a mz axis will be calculated from the given percentage of the files pixels.
                             To this averaged axis, all pixels will be aligned. Problems can arise if pixels do not share the same number of data points. \n
                             Please use the QC tools to check if this is the case."/>
            </when>
            <when value="fixed_binning">
            <!-- ? ?can "value" have two different names? here it is the ppm of the binning axis -->
                <param name="value" label="Choose the binning accuracy in ppm:" type="integer"
                       value="20"
                       help="With this option, a mz axis will be calculated based on the ppm step size provided.
                             To this axis, all pixels will be binned."/>

            </when>
        </conditional>


       <expand macro="m2aia_preprocessing"/>

    </inputs>

    <outputs>
        <data format="imzml" name="outfile_imzml" label="ContinuousProfile imzML, Conversion result of ${on_string}: imzML"/>
    </outputs>

    <tests>
        <!-- Test 1: Default conversion using fixed alignment -->
        <test>
            <param name="infile" value="" ftype="imzml">
                <composite_data value="pp.imzml"/>
                <composite_data value="pp.imzml"/>
            </param>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed_alignment" />
                <param name="value" value="0.5" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml"/>
        </test>

        <!-- Test 2: Conversion using fixed binning -->
        <test>
            <param name="infile" value="" ftype="imzml">
                <composite_data value="pp.imzml"/>
                <composite_data value="pp.imzml"/>
            </param>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed_alignment" />
                <param name="value" value="0.5" />
            </conditional>
            <output name="outfile_imzml" />
        </test>
    
        <!-- Test 4: Conversion using fixed binning with m2aia preprocessing -->
        <test>
            <param name="infile" value="" ftype="imzml">
                <composite_data value="pp.imzml"/>
                <composite_data value="pp.imzml"/>
            </param>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed_alignment" />
                <param name="value" value="0.5" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="TRUE" />
                <param name="nor" value="TIC" />
                <param name="itr" value="Log2" />
                <param name="bsl_hws" value="15" />
                <param name="bsl" value="Median" />
                <param name="smo_hws" value="5" />
                <param name="smo" value="SavitzkyGolay" />
            </conditional>
            <output name="outfile_imzml" />
        </test>
    
        <!-- Test 5: Conversion using fixed alignment with m2aia preprocessing -->
        <test>
            <param name="infile" value="" ftype="imzml">
                <composite_data value="pp.imzml"/>
                <composite_data value="pp.imzml"/>
            </param>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed_alignment" />
                <param name="value" value="0.5" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="TRUE" />
                <param name="nor" value="TIC" />
                <param name="itr" value="Log2" />
                <param name="bsl_hws" value="15" />
                <param name="bsl" value="Median" />
                <param name="smo_hws" value="5" />
                <param name="smo" value="SavitzkyGolay" />
            </conditional>
            <output name="outfile_imzml" />
        </test>
    </tests>
    <help><![CDATA[
    @I2NCA_DESCRIPTION@

    This tool performs the internal conversion from a ProcessedProfile imzml file to a ContinuousProfile imzml file.
    
    **Input data**
    
    @MSIDATA_INPUT_DESCRIPTION@
    
    **Conversion strategy**
    
    The conversion is achieved by using different preprocessing methods.
        - Binning: For binning, he mz values of each pixel are sorted to a fixed reference m/z axis. The axis generation is controlled by a step-length provided in ppm.
        - Alignment: The alignment assumes that all spectra are of the same length and calculates a mean m/z axis, to which the intensities of all pixels get written.
    
    @M2AIA_INPUT_DESCRIPTION@
    ]]></help>
</tool>
