<tool id="i2nca_pp_2_cp" name="i2nca Conversion to continuous profile" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">

	<description>
        Convert processed profile imzML files with i2nca and m2aia.

    </description>
	
    <macros>
    <import>macros.xml</import>
    </macros>
    
    <requirements>
    <!-- We'll skip the reqirements for now. Later we get a biocontainer, for now we'll do wonky conda env stuff-->
    </requirements>

    <!-- ? 2DO w/ Niko: better do deal with CLI or cheetath -->
    <command detect_errors="exit_code"><![CDATA[
    ln -s '$imzml_dataset' './data.imzML' &&
    ln -s '$ibd_dataset' './data.ibd' &&
    #if '$choose_strategy.strategy' == "fixed_alignment":
        #if '$use_m2aia_preproc' == "FALSE":
            '/home/ubuntu/anaconda3/envs/i2nca/bin/python' '$__tool_directory__/pp_2_cp_cli.py' --cov '$choose_strategy.strategy.Coverage' './data.imzML' './data' '$choose_strategy.strategy'
        #else:
            '/home/ubuntu/anaconda3/envs/i2nca/bin/python' '$__tool_directory__/pp_2_cp_cli.py' --cov '$choose_strategy.strategy.Coverage' --bsl '$use_m2aia_preproc.baseline.bsl' --bsl_hws '$use_m2aia_preproc.baseline.bsl_hws' './data.imzML' './data' '$choose_strategy.strategy'
        #end if
    #end if
    #if '$choose_strategy.strategy' == "fixed_binning":
        #if '$use_m2aia_preproc' == "FALSE":
            '/home/ubuntu/anaconda3/envs/i2nca/bin/python' '$__tool_directory__/pp_2_cp_cli.py' --acc '$ppm' './data.imzML' './data' '$choose_strategy.strategy'
        #end if
    #end if
    ]]></command>

    <!-- ? ? 2DO w/ Niko: Adiitional documents that are optional -->
    <inputs>
        <param name="imzml_dataset" label="Input imzml data" type="data" format="imzml"
                help="Load the processed profile .imzml file than needs to be converted to continuous profile." />

        <param name="ibd_dataset" label="Input ibd data" type="data" format="ibd"
                help="Load the processed profile .ibd file than needs to be converted to continuous profile."/>

        <conditional name="choose_strategy">
            <param name="strategy" label="Choose how the continous profile imzML file should be created:" type="select" help="Different stategies can be used.">
                <option value="fixed_alignment" >Alignment</option>
                <option value="fixed_binning" >Binning</option>
            </param>
            <when value="fixed_alignment">
                <param name="Coverage" label="Choose a subsample range for average mz axis calculation:" type="float"
                       value="0.05" min="0.00" max="1.00"
                       help="With this option, a mz axis will be calculated from the given percentage of the files pixels.
                             To this averaged axis, all pixels will be aligned. Problems can arise if pixels do not share the same number of data points. \n
                             Please use the QC tools to check if this is the case."/>
            </when>
            <when value="fixed_binning">
                <param name="ppm" label="Choose the binning accuracy in ppm:" type="integer"
                       value="20"
                       help="With this option, a mz axis will be calculated based on the ppm step size provided.
                             To this axis, all pixels will be binned."/>

            </when>
        </conditional>


       <expand macro="m2aia_preprocessing" />

    </inputs>

    <!-- ? ? 2DO w/ Niko: where to store pdf files -->
    <outputs>
            <data name="ContinuousProfileImzML" label=" ContinuousProfile imzML, Conversion result of ${on_string}" from_work_dir="data_conv_output_cont_profile.imzML" />
            <data name="ContinuousProfileIbd" label=" ContinuousProfile ibd, Conversion result of ${on_string}" from_work_dir="data_conv_output_cont_profile.ibd" />
    </outputs>

    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
</tool>
